services:
  neo4j:
    image: neo4j:latest
    container_name: graphrag-neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-password123}
      - NEO4J_PLUGINS=["apoc"]
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "${NEO4J_USER:-neo4j}", "-p", "${NEO4J_PASSWORD:-password123}", "RETURN 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: graphrag-backend
    env_file:
      - .env
    ports:
      - "8000:8000"
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1
    environment:
      - NEO4J_URI=${NEO4J_URI:-bolt://neo4j:7687}
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_BASE_URL=${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}
      - LLM_MODEL=${LLM_MODEL:-qwen/qwen3-30b-a3b-thinking-2507}
      - MAX_CHARS=${MAX_CHARS:-2500}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - CONTEXT_CHAR_LIMIT=${CONTEXT_CHAR_LIMIT:-120000}
      - ENABLE_INPUT_FILTERING=${ENABLE_INPUT_FILTERING:-true}
      - ENABLE_OUTPUT_FILTERING=${ENABLE_OUTPUT_FILTERING:-true}
      - MAX_URL_LENGTH=${MAX_URL_LENGTH:-2048}
      - MAX_CONTENT_SIZE=${MAX_CONTENT_SIZE:-50000}
    depends_on:
      neo4j:
        condition: service_healthy
    volumes:
      - ./backend:/app/backend
      - ./logs:/app/logs

  bot:
    build:
      context: .
      dockerfile: Dockerfile.bot
    container_name: graphrag-bot
    env_file:
      - .env
    environment:
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - BACKEND_URL=http://backend:8000
    depends_on:
      - backend
    volumes:
      - ./bot:/app/bot

volumes:
  neo4j_data:
  neo4j_logs:

